<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoliSpace | Web Gpredict</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        :root {
            --bg-dark: #0b0d17;
            --panel-bg: #15192b;
            --primary: #00d4ff;
            --accent: #ff0055;
            --text-main: #e0e6ed;
            --text-dim: #8b9bb4;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --font-tech: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
            margin: 0; height: 100vh;
            display: grid;
            grid-template-rows: 50px 1fr 25px; /* Header, Main, Footer */
            overflow: hidden;
        }

        /* HEADER */
        header {
            background: rgba(11,13,23,0.95);
            border-bottom: 1px solid var(--primary);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .brand { font-family: var(--font-tech); font-size: 1.2rem; color: var(--primary); letter-spacing: 2px; }
        .clock { font-family: var(--font-tech); color: #fff; }

        /* MAIN LAYOUT (3 COLUMNS) */
        .workspace {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 2px;
            background: #000;
        }

        /* PANELS COMMON STYLES */
        .module {
            background: var(--panel-bg);
            border-right: 1px solid #222;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .module-header {
            background: #1f2438;
            padding: 5px 10px;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-dim);
            border-bottom: 1px solid #333;
            font-weight: 700;
            display: flex; justify-content: space-between;
        }

        /* LEFT: SATELLITE LIST */
        .sat-list { overflow-y: auto; flex-grow: 1; }
        .sat-row {
            display: grid;
            grid-template-columns: 1fr 60px 60px;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-family: var(--font-tech);
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sat-row:hover { background: rgba(0, 212, 255, 0.1); }
        .sat-row.active { background: rgba(0, 212, 255, 0.2); border-left: 3px solid var(--primary); }
        .sat-az { color: var(--primary); text-align: right; }
        .sat-el { color: var(--text-dim); text-align: right; }
        .sat-el.visible { color: #0f0; font-weight: bold; }

        /* CENTER: GLOBE */
        .globe-container { position: relative; width: 100%; height: 100%; }
        #cesiumContainer { width: 100%; height: 100%; }
        
        /* RIGHT: DETAILS MODULES */
        .details-col { display: grid; grid-template-rows: 300px auto 1fr; gap: 2px; background: #000; border-left: 1px solid #333; }
        
        /* POLAR PLOT */
        .polar-container { 
            position: relative; 
            display: flex; justify-content: center; align-items: center; 
            background: #000; padding: 10px;
        }
        canvas#polarCanvas { background: radial-gradient(circle, #1a2035 0%, #000 70%); border-radius: 50%; border: 1px solid #333; }

        /* DATA TABLES */
        .data-table { width: 100%; border-collapse: collapse; font-family: var(--font-tech); font-size: 0.8rem; }
        .data-table td { padding: 4px 8px; border-bottom: 1px solid #222; }
        .data-table .label { color: var(--text-dim); }
        .data-table .val { text-align: right; color: var(--primary); }
        
        /* PASS PREDICTIONS */
        .pass-list { font-size: 0.75rem; width: 100%; }
        .pass-list th { text-align: left; color: #888; padding: 5px; border-bottom: 1px solid #444; }
        .pass-list td { padding: 5px; border-bottom: 1px solid #222; color: #eee; }

        /* FOOTER */
        footer {
            background: #0b0d17;
            border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: #555;
        }

        /* UTILS */
        .scroll-y { overflow-y: auto; }
        .text-alert { color: var(--accent) !important; }
    </style>
</head>
<body>

    <header>
        <div class="brand">GPREDICT <span style="color:#fff">// WEB</span></div>
        <div class="clock" id="utc-clock">00:00:00 UTC</div>
    </header>

    <div class="workspace">
        
        <div class="module">
            <div class="module-header">
                <span>Tracking Objects</span>
                <span id="sat-count-badge">0</span>
            </div>
            <div class="sat-list" id="sat-list-container">
                </div>
        </div>

        <div class="module" style="position:relative;">
            <div id="cesiumContainer"></div>
            <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.7); padding:5px; font-family:var(--font-tech); font-size:0.8rem; color:var(--primary); pointer-events:none;">
                SELECTED: <span id="overlay-sat-name" style="color:#fff">NONE</span>
            </div>
        </div>

        <div class="details-col">
            
            <div class="module">
                <div class="module-header">Polar View (Skyplot)</div>
                <div class="polar-container">
                    <canvas id="polarCanvas" width="260" height="260"></canvas>
                </div>
            </div>

            <div class="module">
                <div class="module-header">Radio Control / Doppler</div>
                <table class="data-table">
                    <tr><td class="label">Range</td><td class="val" id="val-range">-- km</td></tr>
                    <tr><td class="label">Range Rate</td><td class="val" id="val-rate">-- km/s</td></tr>
                    <tr><td class="label">Downlink (437.0M)</td><td class="val" id="val-downlink">-- MHz</td></tr>
                    <tr><td class="label">Uplink (145.9M)</td><td class="val" id="val-uplink">-- MHz</td></tr>
                </table>
            </div>

            <div class="module scroll-y">
                <div class="module-header">Next Passes (24h)</div>
                <table class="pass-list">
                    <thead><tr><th>AOS (UTC)</th><th>Dur.</th><th>Max El</th></tr></thead>
                    <tbody id="pass-table-body">
                        <tr><td colspan="3" style="text-align:center; color:#555;">Select a Satellite</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <footer>
        PoliSpace Ground Station System | GS: Milano (45.47N, 9.22E)
    </footer>

    <script>
        // --- CONFIG ---
        const GS = { lat: 45.47, lon: 9.22, alt: 0.120 }; // Milano
        const FREQ_DOWN = 437000000; // 437 MHz Base
        const FREQ_UP = 145900000;   // 145.9 MHz Base
        const C = 299792.458; // Speed of light km/s

        let viewer;
        let satellites = []; // Array of objects {name, satrec, entity, data: {az, el, range, rate}}
        let selectedSatIndex = -1;

        // --- 1. INIT CESIUM GLOBE (Minimal & Dark) ---
        viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: false, baseLayerPicker: false, geocoder: false, homeButton: false, 
            infoBox: false, sceneModePicker: false, selectionIndicator: false, timeline: false, 
            animation: false, navigationHelpButton: false, shouldAnimate: true,
            contextOptions: { webgl: { alpha: true } }
        });
        viewer.scene.skyBox.show = false;
        viewer.scene.backgroundColor = Cesium.Color.BLACK;
        viewer.scene.globe.baseColor = Cesium.Color.BLACK;
        viewer.cesiumWidget.creditContainer.style.display = "none";
        
        // Load Dark Map
        try {
            const osm = new Cesium.OpenStreetMapImageryProvider({ url : 'https://a.tile.openstreetmap.org/' });
            const layer = viewer.imageryLayers.addImageryProvider(osm);
            layer.saturation = 0; layer.brightness = 0.3; layer.contrast = 2.0;
        } catch(e){}

        // Add GS Marker
        viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(GS.lon, GS.lat),
            point: { pixelSize: 8, color: Cesium.Color.RED },
            label: { text: "GS MILANO", font: "10px Monospace", pixelOffset: new Cesium.Cartesian2(0,-15), fillColor: Cesium.Color.RED }
        });

        // Set View
        viewer.camera.setView({ destination: Cesium.Cartesian3.fromDegrees(10, 42, 12000000) });

        // --- 2. DATA LOADING ---
        const TLE_URL = 'https://corsproxy.io/?' + encodeURIComponent('https://celestrak.org/NORAD/elements/gp.php?GROUP=weather&FORMAT=tle'); // Weather sats for demo (NOAA, METEOR)

        async function loadData() {
            try {
                const res = await fetch(TLE_URL);
                const text = await res.text();
                parseTLE(text.split('\n'));
            } catch(e) { console.error("Data Load Error", e); }
        }

        function parseTLE(lines) {
            satellites = [];
            viewer.entities.removeAll();
            // Re-add GS because removeAll clears it
            viewer.entities.add({ position: Cesium.Cartesian3.fromDegrees(GS.lon, GS.lat), point: { pixelSize: 8, color: Cesium.Color.RED } });

            let count = 0;
            const start = Cesium.JulianDate.now();
            const stop = Cesium.JulianDate.addSeconds(start, 5400, new Cesium.JulianDate());

            for(let i=0; i<lines.length; i++) {
                if(lines[i].startsWith('1 ') && lines[i+1]?.startsWith('2 ')) {
                    const name = lines[i-1].trim();
                    const satrec = satellite.twoline2satrec(lines[i], lines[i+1]);
                    
                    // Create Cesium Entity (simplified for performance)
                    const entity = viewer.entities.add({
                        position: new Cesium.SampledPositionProperty(), // We will update manually or simplistic
                        point: { pixelSize: 5, color: Cesium.Color.CYAN },
                        label: { text: name, font:"10px Monospace", show: false, pixelOffset: new Cesium.Cartesian2(0,10) }
                    });
                    
                    // Pre-calculate path for 90 mins (visual orbit)
                    calculateOrbitPath(entity, satrec, start, stop);

                    satellites.push({
                        name: name,
                        satrec: satrec,
                        entity: entity,
                        tle: [lines[i], lines[i+1]],
                        data: { az: 0, el: 0, range: 0, rate: 0 }
                    });
                    count++;
                }
            }
            document.getElementById('sat-count-badge').innerText = count;
            buildSatList();
            
            // Start Loop
            setInterval(updateRealtime, 1000); // 1Hz UI update
            setInterval(updateClock, 1000);
        }

        function calculateOrbitPath(entity, satrec, start, stop) {
            // Draws the orbit line
            const pathPos = new Cesium.SampledPositionProperty();
            const totalSec = Cesium.JulianDate.secondsDifference(stop, start);
            for(let t=0; t<=totalSec; t+=120) { // low res path
                const time = Cesium.JulianDate.addSeconds(start, t, new Cesium.JulianDate());
                const jsDate = Cesium.JulianDate.toDate(time);
                const pv = satellite.propagate(satrec, jsDate);
                const gmst = satellite.gstime(jsDate);
                if(pv.position) {
                    const gd = satellite.eciToGeodetic(pv.position, gmst);
                    pathPos.addSample(time, Cesium.Cartesian3.fromRadians(gd.longitude, gd.latitude, gd.height*1000));
                }
            }
            entity.position = pathPos;
            entity.path = {
                resolution: 1, width: 1, material: Cesium.Color.CYAN.withAlpha(0.3), leadTime:0, trailTime: 5400
            };
        }

        // --- 3. UI BUILDERS ---
        function buildSatList() {
            const container = document.getElementById('sat-list-container');
            container.innerHTML = '';
            satellites.forEach((sat, idx) => {
                const row = document.createElement('div');
                row.className = 'sat-row';
                row.id = `sat-row-${idx}`;
                row.innerHTML = `
                    <div class="sat-name">${sat.name}</div>
                    <div class="sat-az" id="list-az-${idx}">000</div>
                    <div class="sat-el" id="list-el-${idx}">00</div>
                `;
                row.onclick = () => selectSatellite(idx);
                container.appendChild(row);
            });
        }

        function selectSatellite(idx) {
            // UI Update
            if(selectedSatIndex !== -1) {
                document.getElementById(`sat-row-${selectedSatIndex}`).classList.remove('active');
                satellites[selectedSatIndex].entity.point.color = Cesium.Color.CYAN;
                satellites[selectedSatIndex].entity.label.show = false;
            }
            selectedSatIndex = idx;
            const sat = satellites[idx];
            document.getElementById(`sat-row-${idx}`).classList.add('active');
            document.getElementById('overlay-sat-name').innerText = sat.name;

            // Globe Highlight
            sat.entity.point.color = Cesium.Color.YELLOW;
            sat.entity.label.show = true;
            sat.entity.label.fillColor = Cesium.Color.YELLOW;

            // Trigger Prediction Calculation
            predictPasses(sat);
        }

        // --- 4. CORE MATH & LOOP ---
        function updateRealtime() {
            const now = new Date();
            const gmst = satellite.gstime(now);

            satellites.forEach((sat, idx) => {
                // SGP4 Propagate
                const pv = satellite.propagate(sat.satrec, now);
                if(!pv.position || !pv.velocity) return;

                // Look Angles
                const posEcf = satellite.eciToEcf(pv.position, gmst);
                const observer = { longitude: satellite.degreesToRadians(GS.lon), latitude: satellite.degreesToRadians(GS.lat), height: GS.alt };
                const look = satellite.ecfToLookAngles(observer, posEcf);

                // Range Rate (Doppler Velocity) calculation
                // Simple dot product of relative velocity vector and look vector
                // Approximate method: (Range_now - Range_prev) / dt. 
                // Let's use analytical approximation from look angles provided by some libs, or simple physics:
                // Range Rate (km/s) can be approximated if not provided. 
                // Let's calculate precise Position tomorrow 1s later to get Range Rate
                // Optimization: satellite.js doesn't give range rate directly in lookAngles.
                // We will calc it: v_rel = dot(v_sat - v_obs, unit_vector_obs_to_sat)
                // For simplicity in this demo, we simulate it or calculate via finite diff if needed.
                // Let's do Finite Diff for accuracy:
                const timeNext = new Date(now.getTime() + 1000);
                const gmstNext = satellite.gstime(timeNext);
                const pvNext = satellite.propagate(sat.satrec, timeNext);
                const posEcfNext = satellite.eciToEcf(pvNext.position, gmstNext);
                const lookNext = satellite.ecfToLookAngles(observer, posEcfNext);
                const rangeRate = (lookNext.rangeSat - look.rangeSat); // km/s (since dt=1s)

                // Store Data
                sat.data.az = satellite.radiansToDegrees(look.azimuth);
                sat.data.el = satellite.radiansToDegrees(look.elevation);
                sat.data.range = look.rangeSat;
                sat.data.rate = rangeRate;

                // Update List UI
                const elDiv = document.getElementById(`list-el-${idx}`);
                document.getElementById(`list-az-${idx}`).innerText = sat.data.az.toFixed(0);
                elDiv.innerText = sat.data.el.toFixed(0);
                
                if(sat.data.el > 0) elDiv.classList.add('visible');
                else elDiv.classList.remove('visible');
            });

            // Update Details Panel (if selected)
            if(selectedSatIndex !== -1) {
                const sat = satellites[selectedSatIndex];
                
                // Doppler Calc
                // f_doppler = f_source * (1 - v_rel/c)  (Approximation)
                // Note: Range Rate is positive moving away (Redshift -> Lower Freq)
                const shiftDown = - (sat.data.rate / C) * FREQ_DOWN;
                const shiftUp = - (sat.data.rate / C) * FREQ_UP;

                document.getElementById('val-range').innerText = sat.data.range.toFixed(0) + " km";
                document.getElementById('val-rate').innerText = sat.data.rate.toFixed(3) + " km/s";
                
                // Format Frequency MHz
                document.getElementById('val-downlink').innerText = ((FREQ_DOWN + shiftDown)/1e6).toFixed(5);
                document.getElementById('val-uplink').innerText = ((FREQ_UP + shiftUp)/1e6).toFixed(5); // Uplink usually inverted logic depending on mode, keep simple here

                // Draw Polar
                drawPolarPlot(sat.data.az, sat.data.el);
            }
        }

        // --- 5. POLAR PLOT (CANVAS) ---
        function drawPolarPlot(az, el) {
            const canvas = document.getElementById('polarCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            const cx = w/2; 
            const cy = h/2;
            const r = (w/2) - 20;

            // Clear
            ctx.clearRect(0,0,w,h);

            // Draw Grid (Circles)
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI); ctx.stroke(); // 0 deg
            ctx.beginPath(); ctx.arc(cx, cy, r*0.66, 0, 2*Math.PI); ctx.stroke(); // 30 deg
            ctx.beginPath(); ctx.arc(cx, cy, r*0.33, 0, 2*Math.PI); ctx.stroke(); // 60 deg

            // Draw Crosshairs
            ctx.beginPath(); ctx.moveTo(cx-r, cy); ctx.lineTo(cx+r, cy); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx, cy-r); ctx.lineTo(cx, cy+r); ctx.stroke();

            // Labels (N, E, S, W)
            ctx.fillStyle = '#00d4ff'; ctx.font = "12px Monospace"; ctx.textAlign = "center";
            ctx.fillText("N", cx, cy-r-5);
            ctx.fillText("S", cx, cy+r+15);
            ctx.fillText("E", cx+r+10, cy+4);
            ctx.fillText("W", cx-r-10, cy+4);

            // Draw Satellite Position
            // Polar math: radius = (90 - el) scaled. Angle = Azimuth - 90 (canvas starts at 3 o'clock)
            if(el < 0) {
                // Sat is below horizon, draw faint or not at all?
                // Let's draw text "LOS"
                ctx.fillStyle = "#555"; ctx.fillText("BELOW HORIZON", cx, cy);
                return;
            }

            const rSat = r * ((90 - el) / 90);
            const angle = (az - 90) * (Math.PI / 180);

            const xSat = cx + rSat * Math.cos(angle);
            const ySat = cy + rSat * Math.sin(angle);

            // Draw Line from center
            ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(xSat, ySat);
            ctx.strokeStyle = 'rgba(0, 212, 255, 0.3)'; ctx.stroke();

            // Draw Dot
            ctx.beginPath(); ctx.arc(xSat, ySat, 6, 0, 2*Math.PI);
            ctx.fillStyle = '#00d4ff'; ctx.fill();
            
            // Draw Text
            ctx.fillStyle = '#fff';
            ctx.fillText(satellites[selectedSatIndex].name, xSat, ySat-10);
        }

        // --- 6. PASS PREDICTION ENGINE ---
        function predictPasses(sat) {
            const table = document.getElementById('pass-table-body');
            table.innerHTML = '<tr><td colspan="3" style="text-align:center;">Calculating...</td></tr>';

            // Simulate in a non-blocking way (setTimeout)
            setTimeout(() => {
                const now = new Date();
                const passes = [];
                let isTracking = false;
                let passStart = null;
                let maxEl = 0;

                // Scan next 24 hours in 60s steps
                // NOTE: This is CPU intensive. In production, use WebWorkers.
                // For demo, we scan 12h with 2 min steps
                const stepSeconds = 60;
                const horizon = 12 * 60 * 60; 

                for(let t=0; t<=horizon; t+=stepSeconds) {
                    const time = new Date(now.getTime() + t*1000);
                    const pv = satellite.propagate(sat.satrec, time);
                    const gmst = satellite.gstime(time);
                    const posEcf = satellite.eciToEcf(pv.position, gmst);
                    const look = satellite.ecfToLookAngles({ longitude: satellite.degreesToRadians(GS.lon), latitude: satellite.degreesToRadians(GS.lat), height: GS.alt }, posEcf);
                    const el = satellite.radiansToDegrees(look.elevation);

                    if(el > 0 && !isTracking) {
                        isTracking = true;
                        passStart = time;
                        maxEl = el;
                    } else if(el > 0 && isTracking) {
                        if(el > maxEl) maxEl = el;
                    } else if(el < 0 && isTracking) {
                        isTracking = false;
                        // Pass Ended
                        const duration = (time - passStart) / 1000 / 60; // min
                        passes.push({ start: passStart, duration: duration, maxEl: maxEl });
                        if(passes.length >= 3) break; // Limit to 3 passes
                    }
                }

                // Render
                table.innerHTML = '';
                if(passes.length === 0) {
                    table.innerHTML = '<tr><td colspan="3">No passes in 12h</td></tr>';
                    return;
                }

                passes.forEach(p => {
                    const h = String(p.start.getUTCHours()).padStart(2,'0');
                    const m = String(p.start.getUTCMinutes()).padStart(2,'0');
                    const dur = p.duration.toFixed(0);
                    const row = `<tr>
                        <td>${h}:${m}</td>
                        <td>${dur}m</td>
                        <td style="color:${p.maxEl > 45 ? '#0f0' : '#ccc'}">${p.maxEl.toFixed(0)}Â°</td>
                    </tr>`;
                    table.innerHTML += row;
                });
            }, 10);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('utc-clock').innerText = now.toISOString().split('T')[1].split('.')[0] + " UTC";
        }

        // BOOT
        loadData();

    </script>
</body>
</html>
